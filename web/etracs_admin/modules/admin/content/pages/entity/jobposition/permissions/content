<%
	def ROLE_LOOKUP = ANUBIS.getFileInfo( '/'+MODULE.name+'/entity/role/lookup.pg' );
%>
<script>	
	@register( ROLE_LOOKUP.path )
	
	\$put( "$PAGE.context", 
		new function() {
			var svc = Service.lookup("admin/JobpositionService");
			
			var self = this;
			this.selectedRole;

			this.saveHandler;
			this.jobposition;
			
			this.roles = [];
			this.permissions = [];
			
			this.onload = function() {
				this.roles = svc.getRoles( this.jobposition );
			}
			
			this.addRole = function() {
				var selector = function(x) {
					var exist = self.roles.findAll( function(o) { return (o.sysrole == x.sysrole && o.domain == x.domain) } );
					if( exist.length > 0 ) 
						throw new Error('Role of the same type already exists');
					self.roles.push( x );
					self._controller.refresh();
				}
				return new PopupOpener( "${ROLE_LOOKUP.name}", {selectHandler: selector} );
			}	
			
			this.removeRole = function() {
				if(!this.selectedRole) return;
				var _selected = this.selectedRole;
				this.roles.removeAll( function(x) { return (x.role == _selected.role && x.domain==_selected.domain); }  );
				this.permissions = [];
				this.selectedRole = null;
			}
			
			this.propertyChangeListener = {
				"selectedRole" : function(o) {
					if( !self.selectedRole.permissions) {
						var parms = {
							role:o.role, 
							domain: o.domain,
							jobpositionid: self.jobposition.objid, 
							disallowed: o.disallowed 
						}
						self.selectedRole.permissions = svc.getRolePermissions(parms); 
					}
					self.permissions = self.selectedRole.permissions;
				}
			}
			
			this.updatePermissions = function() {
				var o = {
					objid: this.jobposition.objid,
					roles: this.roles
				}
				svc.updatePermissions(o);
				return "_close";
			}
		}
	);
</script>


<style>
	.permission-box {
		border: 1px solid gray;
	}
	.roles .selected {
		background-color: yellow;
	}
</style>

<table cellpadding="0" cellspacing="0">
	<tr>
		<td>Code:</td>
		<td><label r:context="$PAGE.context" r:name="jobposition.code"/></td>
	</tr>
	<tr>
		<td>Title:</td>
		<td><label r:context="$PAGE.context" r:name="jobposition.title"/></td>
	</tr>
</table>

<table width="100%">
	<tr>
		<td valign="top">Roles</td>
		<td valign="top">Permissions</td>
	</tr>
	<tr>
		<td valign="top" height="200" width="150" class="permission-box">
			<table r:context="$PAGE.context" r:items="roles" r:name="selectedRole" r:varName="item" r:varStatus="stat" 
				class="roles" width="100%">
				<tr>
					<td>#{item.role}</td>
				</tr>
			</table>
		</td>
		<td valign="top" class="permission-box">
			<table r:context="$PAGE.context" r:items="permissions" r:depends="selectedRole" r:varName="item" r:varStatus="stat" width="100%">
				<tr>
					<td width="10">
						<input type="checkbox" r:context="$PAGE.context" r:name="permissions[#{stat.index}].allowed"/>
					</td>
					<td>#{item.title}</td>
				</tr>
			</table>
		</td>
	</tr>
	<tr>
		<td>
			<button r:context="$PAGE.context" r:name="addRole">Add</button>
			<button r:context="$PAGE.context" r:visibleWhen="#{selectedRole}" r:depends="selectedRole" r:name="removeRole">Remove</button>
		</td>
		<td align="right">
			<button r:context="$PAGE.context" r:name="updatePermissions">Apply</button>
			<button r:context="$PAGE.context" r:name="_close">Close</button>
		</td>
	</tr>
</table>



