<?xml version="1.0" encoding="UTF-8"?>
<!--
    
    @description: CTC-Individual TC Plugin
    
-->
<workunit>
    <invokers>
        <invoker type="collection" caption="CTC-Individual" afid="0016" appcode="ctc_individual" permission="collection_ctc_individual.create"/>
        <invoker type="tc:ctc_individual" action="init" caption="CTC-Individual" afid="0016" permission="collection_ctc_individual.create"/>
        
        <invoker type="initActions" action="back" caption="Back" mnemonic="b"  immediate="true" icon="images/back.png"/>
        
        <invoker type="formActions" action="doNew" caption="New" mnemonic="n" shortcut="ctrl N" visibleWhen="#{mode == 'view' and txnmode != null}" permission="collection_ctc_individual.create"  icon="images/doc-new.png"/>
        <invoker type="formActions" action="_init" caption="Back" mnemonic="b"  immediate="true" visibleWhen="#{mode == 'create'}" icon="images/back.png"/>
        <invoker type="formActions" action="create" caption="Save" mnemonic="s" shortcut="ctrl S" visibleWhen="#{mode == 'create'}" icon="images/save.png"/>
        <invoker type="formActions" action="update" caption="Save" mnemonic="s" shortcut="ctrl S" visibleWhen="#{mode == 'edit'}"  icon="images/save.png"/>
        <invoker type="formActions" action="doPrint" caption="Print" mnemonic="p" shortcut="ctrl P" visibleWhen="#{mode == 'view'}" permission="collection_ctc_individual.print"/>
        <invoker type="formActions" action="doVoid" caption="Void" mnemonic="v" visibleWhen="#{mode == 'view'}" permission="collection_ctc_individual.void" icon="images/void.png"/>
        
        <invoker type="receipt.actions:tc:ctc_individual" action="edit" caption="Edit" mnemonic="e" shortcut="ctrl E" target="popup" permission="collection_ctc_individual.edit" icon="images/edit.png"/>
        <invoker type="receipt.actions:tc:ctc_individual" action="doPrint" caption="Print" mnemonic="p" shortcut="ctrl P" permission="collection_ctc_individual.print"/>
        <invoker type="receipt.actions:tc:ctc_individual" action="doVoid" caption="Void" mnemonic="v" permission="collection_ctc_individual.void" icon="images/doc-void.png"/>
        
        <invoker type="inquiry:tc:ctc_individual" action="initInquiry" caption="Inquiry" />
        
        
        <!--======== BARANGAY COLLECTION SUPPORT ===========-->
        <invoker type="collection" caption="CTC-Individual (Barangay)" afid="0016" appcode="ctc_individual_brgy" permission="collection_ctc_individual_brgy.create"/>
        <invoker type="tc:ctc_individual_brgy" action="initBarangay" caption="CTC-Individual (Barangay)" afid="0016" permission="collection_ctc_individual_brgy.create"/>
        
        <invoker type="initActions" action="back" caption="Back" mnemonic="b"  immediate="true" icon="images/back.png"/>
        
        <invoker type="formActions" action="doNew" caption="New" mnemonic="n" shortcut="ctrl N" visibleWhen="#{mode == 'view' and txnmode != null}" permission="collection_ctc_individual_brgy.create"  icon="images/doc-new.png"/>
        <invoker type="formActions" action="doPrint" caption="Print" mnemonic="p" shortcut="ctrl P" visibleWhen="#{mode == 'view'}" permission="collection_ctc_individual_brgy.print"/>
        <invoker type="formActions" action="doVoid" caption="Void" mnemonic="v" visibleWhen="#{mode == 'view'}" permission="collection_ctc_individual_brgy.void" icon="images/void.png"/>
        
        <invoker type="receipt.actions:tc:ctc_individual_brgy" action="edit" caption="Edit" mnemonic="e" shortcut="ctrl E" target="popup" permission="collection_ctc_individual_brgy.edit" icon="images/edit.png"/>
        <invoker type="receipt.actions:tc:ctc_individual_brgy" action="doPrint" caption="Print" mnemonic="p" shortcut="ctrl P" permission="collection_ctc_individual_brgy.print"/>
        <invoker type="receipt.actions:tc:ctc_individual_brgy" action="doVoid" caption="Void" mnemonic="v" permission="collection_ctc_individual_brgy.void" icon="images/doc-void.png"/>
        
        <invoker type="inquiry:tc:ctc_individual_brgy" action="initInquiry" caption="Inquiry" />
    </invokers>
    
    <code lang="groovy">
        <![CDATA[
        
        import com.rameses.rcp.common.*
        import com.rameses.rcp.annotations.*
        import com.rameses.osiris2.client.*
        import com.rameses.osiris2.reports.*
        import etracs2.tc.groovy.*
        
        public class CTCIndividualReceiptController extends AbstractCollectionController
        {
            @Service("EntityService")
            def entitySvc;
            
            @Service("CTCService")
            def ctcSvc;
            
            @Service("ReceiptService")
            def svc;
            
            @Service('ReportParameterService')
            def paramsSvc;
            
            @Service('LguService')
            def lguSvc;
            
            @Service('CTCReceiptHtmlService')
            def htmlSvc;
        
            def collectiontitle = 'COMMUNITY TAX CERTIFICATE (INDIVIDUAL)'
            def taxpayer
            def taxpayerLookup = InvokerUtil.lookupOpener("entity\\.lookup", [:])
            def genderList = ['MALE','FEMALE']
            
            def barangay
            def orgtype
            def brgylookup
            
            void init() {
                super.init();
                entity.doctype = 'CTCI'
            }
            
            void initBarangay() {
                super.init();
                if( OsirisContext.env.CLIENT?.orgtype == 'BARANGAY' ) {
                    orgtype = OsirisContext.env.CLIENT?.orgtype
                    def brgy = lguSvc.open( OsirisContext.env.CLIENT.refid );
                    setBarangay( [objid: brgy.objid, name: brgy.lguname] )
                }
                entity.doctype = 'CTCIB'
                brgylookup = InvokerUtil.lookupOpener('barangay.lookup', [:])
            }
            
            def next() {
                if(taxpayer && taxpayer.entitytype != 'individual') {
                    MsgBox.err('Selected taxpayer is not an INDIVIDUAL type.')
                    return;
                }
                
                if( !taxpayer ) {
                    entity.info.payer = [
                        entitytype : 'individual',
                        info:[:]
                    ]
                }
                
                entity.tax = [
                    basic:    0.00,
                    business: 0.00,
                    property: 0.00,
                    salary:   0.00,
                    interest: 0.00,
                ]
                entity.annualsalary = 0.00
                entity.businessgross = 0.00
                entity.propertyincome = 0.00
                return 'new'
            }
            
            void setTaxpayer( tp ) {
                this.taxpayer = tp
                if( !entity.info.payer ) entity.info.payer = [:]
                
                if( !tp ) {
                    entity.info.payer = [info:[:]]
                }
                else {
                    tp = entitySvc.open( tp.objid, tp.entitytype );
                    if( !tp ) throw new Exception("Taxpayer record cannot be opened.");
                    
                    entity.info.payer.clear();
                    entity.info.payer.putAll( tp );
                }
            }
            
            void setBarangay( brgy ) {
                entity.barangayid = brgy.objid;
                entity.barangayname = brgy.name;
                this.barangay = brgy
            }
            
            void calculate() {
                def result = ctcSvc.calculate( entity );
                entity.tax = result.tax;
                entity.info.amount = result.total;
                entity.items = result.items;
            }
            
            void acceptTaxDue() {
                def total = 0.00;
                if( entity.tax.business ) total += entity.tax.business;
                if( entity.tax.basic )    total += entity.tax.basic;
                if( entity.tax.salary )   total += entity.tax.salary;
                if( entity.tax.property ) total += entity.tax.property;
                if( entity.tax.interest ) total += entity.tax.interest;
                entity.info.amount = total;
            }
            
            def getService() { return svc }
            def getHtmlService() { return htmlSvc }
            
            def getCollectionTitle() { return collectiontitle }

            def getParameters() { 
                return paramsSvc.getStandardParameter( OsirisContext.env.USERNAME )
            }
            
            def getReportName() { return 'AF0016' }
        }
        
        
        ]]>
    </code>
    
    <pages>
        <page name="init" template="etracs2.ctc.tc.ui.CTCInitPage"/>
        <page name="new" template="etracs2.ctc.tc.ui.IndividualPage"/>
        <page name="view" template="etracs2.tc.collection.CollectionViewPage"/>
        <page name="html" template="etracs2.tc.HtmlPage"/>
    </pages>
</workunit>
